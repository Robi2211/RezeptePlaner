<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:RezeptePlaner.Maui.ViewModels"
             xmlns:models="clr-namespace:RezeptePlaner.Maui.Models"
             xmlns:controls="clr-namespace:RezeptePlaner.Maui.Controls"
             x:Class="RezeptePlaner.Maui.Views.FavoritesPage"
             x:DataType="viewmodels:FavoritesViewModel"
             Title="Favoriten"
             BackgroundColor="{StaticResource Background}">

    <Grid RowDefinitions="Auto,*">
        <!-- Navigation Header -->
        <controls:NavigationHeader Grid.Row="0" CurrentPage="Favoriten" />

        <ScrollView Grid.Row="1">
            <Grid Padding="20" RowDefinitions="Auto,Auto,*">
        
        <!-- Page Header -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*" Margin="0,0,0,30">
            <Frame Grid.Column="0"
                   BackgroundColor="{StaticResource Destructive}"
                   CornerRadius="16"
                   WidthRequest="64"
                   HeightRequest="64"
                   Padding="0"
                   Margin="0,0,16,0">
                <Label Text="â¤ï¸"
                       FontSize="32"
                       HorizontalOptions="Center"
                       VerticalOptions="Center" />
            </Frame>
            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                <Label Text="Meine Favoriten" 
                       Style="{StaticResource PageTitle}"
                       Margin="0" />
                <Label Text="{Binding FavoriteCount, StringFormat='{0} Lieblingsrezepte gespeichert'}"
                       TextColor="{StaticResource ForegroundMuted}"
                       FontSize="16" />
            </VerticalStackLayout>
        </Grid>

        <!-- Search Bar -->
        <Frame Grid.Row="1" 
               Style="{StaticResource CardFrame}"
               Margin="0,0,0,20"
               IsVisible="{Binding FavoriteCount}">
            <Border BackgroundColor="{StaticResource Muted}"
                    Stroke="{StaticResource Border}"
                    StrokeShape="RoundRectangle 12"
                    Padding="16,12">
                <Entry Text="{Binding SearchText}"
                       Placeholder="ðŸ” Favoriten durchsuchen..."
                       PlaceholderColor="{StaticResource ForegroundMuted}"
                       TextColor="{StaticResource Foreground}"
                       BackgroundColor="Transparent"
                       FontSize="16" />
            </Border>
        </Frame>

        <!-- Content Area -->
        <Grid Grid.Row="2">
            
            <!-- Empty State -->
            <Frame Style="{StaticResource CardFrame}"
                   VerticalOptions="Center"
                   IsVisible="{Binding FavoriteCount, Converter={StaticResource InvertedBoolConverter}}">
                <VerticalStackLayout Spacing="20" HorizontalOptions="Center" Padding="40">
                    <Frame BackgroundColor="{StaticResource Muted}"
                           CornerRadius="48"
                           WidthRequest="96"
                           HeightRequest="96"
                           Padding="0"
                           HorizontalOptions="Center">
                        <Label Text="â¤ï¸"
                               FontSize="48"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               Opacity="0.5" />
                    </Frame>
                    <Label Text="Noch keine Favoriten"
                           TextColor="{StaticResource Foreground}"
                           FontSize="22"
                           FontAttributes="Bold"
                           HorizontalOptions="Center" />
                    <Label Text="Markiere Rezepte mit einem Herz, um sie hier zu speichern und schnell wiederzufinden."
                           TextColor="{StaticResource ForegroundMuted}"
                           FontSize="16"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center"
                           MaxLines="3" />
                    <Button Text="Rezepte entdecken"
                            Command="{Binding NavigateToRecipesCommand}"
                            Style="{StaticResource PrimaryButton}"
                            HorizontalOptions="Center"
                            Margin="0,20,0,0" />
                </VerticalStackLayout>
            </Frame>

            <!-- Favorites Grid -->
            <CollectionView ItemsSource="{Binding FilteredRecipes}"
                            SelectionMode="None"
                            IsVisible="{Binding FavoriteCount}">
                
                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" 
                                         VerticalOptions="Center"
                                         Padding="40">
                        <Label Text="Keine Rezepte gefunden"
                               TextColor="{StaticResource ForegroundMuted}"
                               FontSize="18"
                               HorizontalOptions="Center" />
                        <Label Text="Versuche andere Suchbegriffe"
                               TextColor="{StaticResource ForegroundMuted}"
                               FontSize="14"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical"
                                     Span="3"
                                     HorizontalItemSpacing="20"
                                     VerticalItemSpacing="20" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Recipe">
                        <Frame Style="{StaticResource CardFrame}"
                               Padding="0">
                            <Grid RowDefinitions="180,*">
                                
                                <!-- Recipe Image Placeholder -->
                                <Grid Grid.Row="0">
                                    <BoxView Color="{StaticResource Muted}"
                                             CornerRadius="12,12,0,0" />
                                    <Image Source="{Binding ImageUrl}"
                                           Aspect="AspectFill"
                                           HeightRequest="180"
                                           VerticalOptions="Fill"
                                           HorizontalOptions="Fill">
                                        <Image.Clip>
                                            <RoundRectangleGeometry CornerRadius="12,12,0,0" 
                                                                   Rect="0,0,400,180" />
                                        </Image.Clip>
                                    </Image>
                                    <Label Text="ðŸ½ï¸"
                                           FontSize="60"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"
                                           IsVisible="{Binding ImageUrl, Converter={StaticResource IsNullOrEmptyConverter}}" />
                                    
                                    <!-- Favorite Button -->
                                    <Frame BackgroundColor="{StaticResource Surface}"
                                           CornerRadius="20"
                                           WidthRequest="48"
                                           HeightRequest="48"
                                           Padding="0"
                                           Margin="12"
                                           HorizontalOptions="End"
                                           VerticalOptions="Start">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FavoritesViewModel}}, Path=ToggleFavoriteCommand}"
                                                CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>
                                        <Label Text="â¤ï¸"
                                               FontSize="24"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Frame>
                                </Grid>
                                
                                <!-- Recipe Info -->
                                <VerticalStackLayout Grid.Row="1" Padding="16">
                                    <VerticalStackLayout.GestureRecognizers>
                                        <TapGestureRecognizer 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FavoritesViewModel}}, Path=ViewRecipeCommand}"
                                            CommandParameter="{Binding .}" />
                                    </VerticalStackLayout.GestureRecognizers>
                                    
                                    <!-- Category & Difficulty Badges -->
                                    <HorizontalStackLayout Spacing="8" Margin="0,0,0,12">
                                        <Frame BackgroundColor="{StaticResource Primary}"
                                               CornerRadius="8"
                                               Padding="10,4">
                                            <Label Text="{Binding CategoryDisplay}"
                                                   TextColor="{StaticResource Background}"
                                                   FontSize="12" />
                                        </Frame>
                                        <Frame BackgroundColor="{StaticResource Muted}"
                                               CornerRadius="8"
                                               Padding="10,4">
                                            <Label Text="{Binding DifficultyDisplay}"
                                                   TextColor="{StaticResource ForegroundMuted}"
                                                   FontSize="12" />
                                        </Frame>
                                    </HorizontalStackLayout>
                                    
                                    <!-- Title -->
                                    <Label Text="{Binding Title}"
                                           TextColor="{StaticResource Foreground}"
                                           FontSize="17"
                                           FontAttributes="Bold"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="2"
                                           Margin="0,0,0,12" />
                                    
                                    <!-- Meta Info -->
                                    <Grid ColumnDefinitions="*,*" 
                                          Margin="0,0,0,12"
                                          Padding="0,12,0,0">
                                        <Grid.Resources>
                                            <Style TargetType="BoxView">
                                                <Setter Property="HeightRequest" Value="1" />
                                                <Setter Property="BackgroundColor" Value="{StaticResource Border}" />
                                            </Style>
                                        </Grid.Resources>
                                        <BoxView Grid.ColumnSpan="2" VerticalOptions="Start" Margin="0,-12,0,0" />
                                        
                                        <HorizontalStackLayout Grid.Column="0" Spacing="6">
                                            <Label Text="â±ï¸" FontSize="14" />
                                            <Label Text="{Binding TotalTime, StringFormat='{0} Min'}"
                                                   TextColor="{StaticResource ForegroundMuted}"
                                                   FontSize="14" />
                                        </HorizontalStackLayout>
                                        <HorizontalStackLayout Grid.Column="1" Spacing="6">
                                            <Label Text="ðŸ‘¥" FontSize="14" />
                                            <Label Text="{Binding Servings, StringFormat='{0} Portionen'}"
                                                   TextColor="{StaticResource ForegroundMuted}"
                                                   FontSize="14" />
                                        </HorizontalStackLayout>
                                    </Grid>
                                    
                                    <!-- Tags -->
                                    <CollectionView ItemsSource="{Binding Tags}"
                                                    HeightRequest="28"
                                                    Margin="0,0,0,12">
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="6" />
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="x:String">
                                                <Frame BackgroundColor="{StaticResource Muted}"
                                                       CornerRadius="12"
                                                       Padding="10,4">
                                                    <Label Text="{Binding StringFormat='#{0}'}"
                                                           TextColor="{StaticResource ForegroundMuted}"
                                                           FontSize="11" />
                                                </Frame>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                    
                                    <!-- Saved Status -->
                                    <HorizontalStackLayout Spacing="6">
                                        <Label Text="ðŸ”–" FontSize="12" />
                                        <Label Text="Als Favorit gespeichert"
                                               TextColor="{StaticResource Teal}"
                                               FontSize="12" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
            </Grid>
        </ScrollView>
    </Grid>
</ContentPage>
