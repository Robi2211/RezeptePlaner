<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:RezeptePlaner.Maui.ViewModels"
             xmlns:models="clr-namespace:RezeptePlaner.Maui.Models"
             xmlns:controls="clr-namespace:RezeptePlaner.Maui.Controls"
             x:Class="RezeptePlaner.Maui.Views.FavoritesPage"
             x:DataType="viewmodels:FavoritesViewModel"
             Title="Favoriten"
             BackgroundColor="{StaticResource Background}">

    <Grid RowDefinitions="Auto,*">
        <!-- Navigation Header -->
        <controls:NavigationHeader Grid.Row="0" CurrentPage="Favoriten" />

        <ScrollView Grid.Row="1">
            <Grid RowDefinitions="Auto,Auto,*">
                <Grid.Padding>
                    <OnIdiom x:TypeArguments="Thickness">
                        <OnIdiom.Phone>10</OnIdiom.Phone>
                        <OnIdiom.Tablet>20</OnIdiom.Tablet>
                        <OnIdiom.Desktop>20</OnIdiom.Desktop>
                    </OnIdiom>
                </Grid.Padding>
        
                <!-- Page Header -->
                <Grid Grid.Row="0" ColumnDefinitions="Auto,*" Margin="0,0,0,30">
                    <Frame Grid.Column="0"
                           BackgroundColor="{StaticResource Destructive}"
                           CornerRadius="16"
                           WidthRequest="64"
                           HeightRequest="64"
                           Padding="0"
                           Margin="0,0,16,0">
                        <Label Text="â¤ï¸"
                               FontSize="32"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />
                    </Frame>
                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                        <Label Text="Meine Favoriten" 
                               Style="{StaticResource PageTitle}"
                               Margin="0" />
                        <Label Text="{Binding FavoriteCount, StringFormat='{0} Lieblingsrezepte gespeichert'}"
                               TextColor="{StaticResource ForegroundMuted}"
                               FontSize="16" />
                    </VerticalStackLayout>
                </Grid>

                <!-- Search Bar -->
                <Frame Grid.Row="1" 
                       Style="{StaticResource CardFrame}"
                       Margin="0,0,0,20"
                       IsVisible="{Binding FavoriteCount}">
                    <Border BackgroundColor="{StaticResource Muted}"
                            Stroke="{StaticResource Border}"
                            StrokeShape="RoundRectangle 12"
                            Padding="16,12">
                        <Entry Text="{Binding SearchText}"
                               Placeholder="ðŸ” Favoriten durchsuchen..."
                               PlaceholderColor="{StaticResource ForegroundMuted}"
                               TextColor="{StaticResource Foreground}"
                               BackgroundColor="Transparent"
                               FontSize="16" />
                    </Border>
                </Frame>

                <!-- Content Area -->
                <Grid Grid.Row="2">
                    
                    <!-- Empty State -->
                    <Frame Style="{StaticResource CardFrame}"
                           VerticalOptions="Center"
                           IsVisible="{Binding FavoriteCount, Converter={StaticResource InvertedBoolConverter}}">
                        <VerticalStackLayout Spacing="20" HorizontalOptions="Center" Padding="40">
                            <Frame BackgroundColor="{StaticResource Muted}"
                                   CornerRadius="48"
                                   WidthRequest="96"
                                   HeightRequest="96"
                                   Padding="0"
                                   HorizontalOptions="Center">
                                <Label Text="â¤ï¸"
                                       FontSize="48"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       Opacity="0.5" />
                            </Frame>
                            <Label Text="Noch keine Favoriten"
                                   TextColor="{StaticResource Foreground}"
                                   FontSize="22"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center" />
                            <Label Text="Markiere Rezepte mit einem Herz, um sie hier zu speichern und schnell wiederzufinden."
                                   TextColor="{StaticResource ForegroundMuted}"
                                   FontSize="16"
                                   HorizontalOptions="Center"
                                   HorizontalTextAlignment="Center"
                                   MaxLines="3" />
                            <Button Text="Rezepte entdecken"
                                    Command="{Binding NavigateToRecipesCommand}"
                                    Style="{StaticResource PrimaryButton}"
                                    HorizontalOptions="Center"
                                    Margin="0,20,0,0" />
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Favorites Grid -->
                    <CollectionView ItemsSource="{Binding FilteredRecipes}"
                                    SelectionMode="None"
                                    IsVisible="{Binding FavoriteCount}"
                                    x:Name="FavoritesCollectionView">
                        
                        <VisualStateManager.VisualStateGroups>
                            <VisualStateGroup x:Name="AdaptiveStates">
                                <!-- Small screens (Width < 600): 1 column -->
                                <VisualState x:Name="Small">
                                    <VisualState.StateTriggers>
                                        <AdaptiveTrigger MinWindowWidth="0" />
                                    </VisualState.StateTriggers>
                                    <VisualState.Setters>
                                        <Setter Property="ItemsLayout">
                                            <Setter.Value>
                                                <GridItemsLayout Orientation="Vertical"
                                                               Span="1"
                                                               HorizontalItemSpacing="20"
                                                               VerticalItemSpacing="20" />
                                            </Setter.Value>
                                        </Setter>
                                    </VisualState.Setters>
                                </VisualState>
                                
                                <!-- Medium screens (Width 600-1199): 2 columns -->
                                <VisualState x:Name="Medium">
                                    <VisualState.StateTriggers>
                                        <AdaptiveTrigger MinWindowWidth="600" />
                                    </VisualState.StateTriggers>
                                    <VisualState.Setters>
                                        <Setter Property="ItemsLayout">
                                            <Setter.Value>
                                                <GridItemsLayout Orientation="Vertical"
                                                               Span="2"
                                                               HorizontalItemSpacing="30"
                                                               VerticalItemSpacing="30" />
                                            </Setter.Value>
                                        </Setter>
                                    </VisualState.Setters>
                                </VisualState>
                                
                                <!-- Large/desktop screens (Width >= 1200): 3 columns -->
                                <VisualState x:Name="Large">
                                    <VisualState.StateTriggers>
                                        <AdaptiveTrigger MinWindowWidth="1200" />
                                    </VisualState.StateTriggers>
                                    <VisualState.Setters>
                                        <Setter Property="ItemsLayout">
                                            <Setter.Value>
                                                <GridItemsLayout Orientation="Vertical"
                                                               Span="3"
                                                               HorizontalItemSpacing="40"
                                                               VerticalItemSpacing="40" />
                                            </Setter.Value>
                                        </Setter>
                                    </VisualState.Setters>
                                </VisualState>
                            </VisualStateGroup>
                        </VisualStateManager.VisualStateGroups>
                        
                        <CollectionView.EmptyView>
                            <VerticalStackLayout HorizontalOptions="Center" 
                                                 VerticalOptions="Center"
                                                 Padding="40">
                                <Label Text="Keine Rezepte gefunden"
                                       TextColor="{StaticResource ForegroundMuted}"
                                       FontSize="18"
                                       HorizontalOptions="Center" />
                                <Label Text="Versuche andere Suchbegriffe"
                                       TextColor="{StaticResource ForegroundMuted}"
                                       FontSize="14"
                                       HorizontalOptions="Center" />
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Recipe">
                                <!-- Recipe Card with full width fill -->
                                <Border BackgroundColor="{StaticResource Surface}"
                                        Stroke="{StaticResource Border}"
                                        StrokeThickness="1"
                                        StrokeShape="RoundRectangle 20"
                                        Padding="0"
                                        HorizontalOptions="FillAndExpand"
                                        WidthRequest="-1">
                                    <Border.Shadow>
                                        <Shadow Brush="{StaticResource Gray300}"
                                                Offset="0,2"
                                                Radius="8"
                                                Opacity="0.3" />
                                    </Border.Shadow>
                                    
                                    <Grid RowDefinitions="280,Auto">
                                        
                                        <!-- Recipe Image with rounded top corners -->
                                        <Grid Grid.Row="0">
                                            <BoxView Color="{StaticResource Muted}"
                                                     CornerRadius="20,20,0,0" />
                                            <Image Source="{Binding ImageUrl}"
                                                   Aspect="AspectFill"
                                                   HeightRequest="280"
                                                   VerticalOptions="Fill"
                                                   HorizontalOptions="FillAndExpand">
                                                <Image.Clip>
                                                    <RoundRectangleGeometry CornerRadius="20,20,0,0" 
                                                                           Rect="0,0,5000,280" />
                                                </Image.Clip>
                                            </Image>
                                            <Label Text="ðŸ½ï¸"
                                                   FontSize="60"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   IsVisible="{Binding ImageUrl, Converter={StaticResource IsNullOrEmptyConverter}}" />
                                            
                                            <!-- Favorite Button - top right -->
                                            <Frame BackgroundColor="{StaticResource Surface}"
                                                   CornerRadius="20"
                                                   WidthRequest="48"
                                                   HeightRequest="48"
                                                   Padding="0"
                                                   Margin="12"
                                                   HorizontalOptions="End"
                                                   VerticalOptions="Start">
                                                <Frame.GestureRecognizers>
                                                    <TapGestureRecognizer 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FavoritesViewModel}}, Path=ToggleFavoriteCommand}"
                                                        CommandParameter="{Binding .}" />
                                                </Frame.GestureRecognizers>
                                                <Label Text="{Binding IsFavorite, Converter={StaticResource FavoriteToHeartConverter}}"
                                                       TextColor="{Binding IsFavorite, Converter={StaticResource FavoriteToColorConverter}}"
                                                       FontSize="24"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center" />
                                            </Frame>
                                        </Grid>
                                        
                                        <!-- Recipe Info -->
                                        <VerticalStackLayout Grid.Row="1" Padding="16" Spacing="12">
                                            <VerticalStackLayout.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:FavoritesViewModel}}, Path=ViewRecipeCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </VerticalStackLayout.GestureRecognizers>
                                            
                                            <!-- Category & Difficulty Badges -->
                                            <HorizontalStackLayout Spacing="8">
                                                <Frame BackgroundColor="{StaticResource Primary}"
                                                       CornerRadius="12"
                                                       Padding="12,6"
                                                       HasShadow="False">
                                                    <Label Text="{Binding CategoryDisplay}"
                                                           TextColor="{StaticResource Background}"
                                                           FontSize="12"
                                                           FontAttributes="Bold" />
                                                </Frame>
                                                <Frame BackgroundColor="{StaticResource Muted}"
                                                       CornerRadius="12"
                                                       Padding="12,6"
                                                       HasShadow="False">
                                                    <Label Text="{Binding DifficultyDisplay}"
                                                           TextColor="{StaticResource ForegroundMuted}"
                                                           FontSize="12"
                                                           FontAttributes="Bold" />
                                                </Frame>
                                            </HorizontalStackLayout>
                                            
                                            <!-- Title -->
                                            <Label Text="{Binding Title}"
                                                   TextColor="{StaticResource Foreground}"
                                                   FontSize="18"
                                                   FontAttributes="Bold"
                                                   LineBreakMode="TailTruncation"
                                                   MaxLines="2"
                                                   HorizontalOptions="FillAndExpand" />
                                            
                                            <!-- Divider -->
                                            <BoxView HeightRequest="1" 
                                                     BackgroundColor="{StaticResource Border}" 
                                                     HorizontalOptions="FillAndExpand" />
                                            
                                            <!-- Time + Portions Row -->
                                            <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                                                <HorizontalStackLayout Grid.Column="0" Spacing="6">
                                                    <Label Text="â±ï¸" FontSize="14" />
                                                    <Label Text="{Binding TotalTime, StringFormat='{0} Min'}"
                                                           TextColor="{StaticResource ForegroundMuted}"
                                                           FontSize="14" />
                                                </HorizontalStackLayout>
                                                <HorizontalStackLayout Grid.Column="1" Spacing="6">
                                                    <Label Text="ðŸ‘¥" FontSize="14" />
                                                    <Label Text="{Binding Servings, StringFormat='{0} Portionen'}"
                                                           TextColor="{StaticResource ForegroundMuted}"
                                                           FontSize="14" />
                                                </HorizontalStackLayout>
                                            </Grid>
                                            
                                            <!-- Tags with wrap -->
                                            <FlexLayout Direction="Row" 
                                                        Wrap="Wrap"
                                                        JustifyContent="Start"
                                                        AlignItems="Start"
                                                        BindableLayout.ItemsSource="{Binding Tags}">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="x:String">
                                                        <Frame BackgroundColor="{StaticResource Muted}"
                                                               CornerRadius="12"
                                                               Padding="10,4"
                                                               HasShadow="False"
                                                               Margin="0,0,6,6">
                                                            <Label Text="{Binding StringFormat='#{0}'}"
                                                                   TextColor="{StaticResource ForegroundMuted}"
                                                                   FontSize="11" />
                                                        </Frame>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </FlexLayout>
                                            
                                            <!-- "Als Favorit gespeichert" Banner -->
                                            <Border BackgroundColor="{StaticResource FavoriteBannerBackground}"
                                                    Stroke="{StaticResource FavoriteBannerBorder}"
                                                    StrokeThickness="1"
                                                    StrokeShape="RoundRectangle 12"
                                                    Padding="12,8"
                                                    HorizontalOptions="FillAndExpand">
                                                <HorizontalStackLayout Spacing="8" 
                                                                       HorizontalOptions="Start">
                                                    <Label Text="â¤ï¸" 
                                                           FontSize="14"
                                                           TextColor="{StaticResource Destructive}" />
                                                    <Label Text="Als Favorit gespeichert"
                                                           TextColor="{StaticResource Success}"
                                                           FontSize="12"
                                                           FontAttributes="Bold" />
                                                </HorizontalStackLayout>
                                            </Border>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>
            </Grid>
        </ScrollView>
    </Grid>
</ContentPage>
