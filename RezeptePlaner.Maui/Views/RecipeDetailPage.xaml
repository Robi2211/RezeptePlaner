<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:RezeptePlaner.Maui.ViewModels"
             xmlns:models="clr-namespace:RezeptePlaner.Maui.Models"
             xmlns:controls="clr-namespace:RezeptePlaner.Maui.Controls"
             x:Class="RezeptePlaner.Maui.Views.RecipeDetailPage"
             x:DataType="viewmodels:RecipeDetailViewModel"
             Title="{Binding Recipe.Title}"
             BackgroundColor="{StaticResource Background}">

    <Grid RowDefinitions="Auto,*">
        <!-- Navigation Header -->
        <controls:NavigationHeader Grid.Row="0" CurrentPage="" />

        <ScrollView Grid.Row="1" x:Name="MainScrollView">
            <Grid x:Name="MainContainer" RowDefinitions="Auto,Auto,*">
                <Grid.Padding>
                    <OnIdiom x:TypeArguments="Thickness">
                        <OnIdiom.Phone>20</OnIdiom.Phone>
                        <OnIdiom.Desktop>80,20,80,20</OnIdiom.Desktop>
                        <OnIdiom.Tablet>40,20,40,20</OnIdiom.Tablet>
                    </OnIdiom>
                </Grid.Padding>

                <!-- Back Button -->
                <Button Grid.Row="0"
                        Text="â† ZurÃ¼ck"
                        Command="{Binding GoBackCommand}"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource ForegroundMuted}"
                        HorizontalOptions="Start"
                        Margin="0,0,0,16" />

                <!-- Main Content Grid with VisualStateManager -->
                <Grid Grid.Row="1" x:Name="ContentGrid" RowDefinitions="Auto,Auto" RowSpacing="20">
                    <VisualStateManager.VisualStateGroups>
                        <VisualStateGroup x:Name="AdaptiveStates">
                            <!-- Large Screen: 2-column layout -->
                            <VisualState x:Name="Large">
                                <VisualState.StateTriggers>
                                    <AdaptiveTrigger MinWindowWidth="800" />
                                </VisualState.StateTriggers>
                                <VisualState.Setters>
                                    <Setter TargetName="RecipeImageColumn" Property="Grid.Column" Value="0" />
                                    <Setter TargetName="RecipeImageColumn" Property="Grid.Row" Value="0" />
                                    <Setter TargetName="RecipeMetaColumn" Property="Grid.Column" Value="1" />
                                    <Setter TargetName="RecipeMetaColumn" Property="Grid.Row" Value="0" />
                                    <Setter TargetName="ContentGrid" Property="ColumnDefinitions" Value="*,*" />
                                    <Setter TargetName="ContentGrid" Property="RowDefinitions" Value="Auto,Auto" />
                                    <Setter TargetName="ContentGrid" Property="ColumnSpacing" Value="24" />
                                    <Setter TargetName="IngredientsCard" Property="Grid.Column" Value="0" />
                                    <Setter TargetName="IngredientsCard" Property="Grid.Row" Value="1" />
                                    <Setter TargetName="InstructionsCard" Property="Grid.Column" Value="1" />
                                    <Setter TargetName="InstructionsCard" Property="Grid.Row" Value="1" />
                                    <Setter TargetName="RecipeImage" Property="MaximumHeightRequest" Value="600" />
                                </VisualState.Setters>
                            </VisualState>
                            
                            <!-- Small Screen: Stacked layout -->
                            <VisualState x:Name="Small">
                                <VisualState.StateTriggers>
                                    <AdaptiveTrigger MinWindowWidth="0" />
                                </VisualState.StateTriggers>
                                <VisualState.Setters>
                                    <Setter TargetName="RecipeImageColumn" Property="Grid.Column" Value="0" />
                                    <Setter TargetName="RecipeImageColumn" Property="Grid.Row" Value="0" />
                                    <Setter TargetName="RecipeMetaColumn" Property="Grid.Column" Value="0" />
                                    <Setter TargetName="RecipeMetaColumn" Property="Grid.Row" Value="1" />
                                    <Setter TargetName="ContentGrid" Property="ColumnDefinitions" Value="*" />
                                    <Setter TargetName="ContentGrid" Property="RowDefinitions" Value="Auto,Auto,Auto,Auto" />
                                    <Setter TargetName="ContentGrid" Property="ColumnSpacing" Value="0" />
                                    <Setter TargetName="IngredientsCard" Property="Grid.Column" Value="0" />
                                    <Setter TargetName="IngredientsCard" Property="Grid.Row" Value="2" />
                                    <Setter TargetName="InstructionsCard" Property="Grid.Column" Value="0" />
                                    <Setter TargetName="InstructionsCard" Property="Grid.Row" Value="3" />
                                    <Setter TargetName="RecipeImage" Property="MaximumHeightRequest" Value="400" />
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateManager.VisualStateGroups>

                    <!-- Left Column / Top Row: Recipe Image -->
                    <Grid x:Name="RecipeImageColumn" Grid.Column="0" Grid.Row="0">
                        <Frame Padding="0" 
                               CornerRadius="20" 
                               HasShadow="True"
                               BackgroundColor="{StaticResource Surface}">
                            <Frame.Shadow>
                                <Shadow Brush="{StaticResource Gray400}"
                                        Offset="0,4"
                                        Radius="12"
                                        Opacity="0.2" />
                            </Frame.Shadow>
                            <Image x:Name="RecipeImage"
                                   Source="{Binding Recipe.ImageUrl}"
                                   Aspect="AspectFill"
                                   HeightRequest="400"
                                   MaximumHeightRequest="600"
                                   VerticalOptions="Fill"
                                   HorizontalOptions="Fill">
                                <Image.Clip>
                                    <RoundRectangleGeometry CornerRadius="20" />
                                </Image.Clip>
                            </Image>
                        </Frame>
                        
                        <!-- Favorite Heart Button (Overlaid on Image) -->
                        <Border BackgroundColor="{StaticResource Surface}"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 24"
                                Padding="12"
                                Margin="16"
                                HorizontalOptions="End"
                                VerticalOptions="Start"
                                WidthRequest="48"
                                HeightRequest="48">
                            <Border.Shadow>
                                <Shadow Brush="{StaticResource Gray400}"
                                        Offset="0,2"
                                        Radius="8"
                                        Opacity="0.3" />
                            </Border.Shadow>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleFavoriteCommand}" />
                            </Border.GestureRecognizers>
                            <Label Text="{Binding Recipe.IsFavorite, Converter={StaticResource FavoriteToHeartConverter}}"
                                   TextColor="{Binding Recipe.IsFavorite, Converter={StaticResource FavoriteToColorConverter}}"
                                   FontSize="24"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />
                        </Border>
                    </Grid>

                    <!-- Right Column / Second Row: Recipe Metadata -->
                    <VerticalStackLayout x:Name="RecipeMetaColumn" 
                                        Grid.Column="1" 
                                        Grid.Row="0" 
                                        Spacing="16"
                                        Margin="0,0,0,0">
                        
                        <!-- Category & Difficulty Badges -->
                        <HorizontalStackLayout Spacing="10">
                            <Border BackgroundColor="#FF8C42"
                                   StrokeShape="RoundRectangle 20"
                                   Stroke="Transparent"
                                   Padding="16,8">
                                <Label Text="{Binding Recipe.CategoryDisplay}"
                                       TextColor="{StaticResource White}"
                                       FontSize="13"
                                       FontAttributes="Bold" />
                            </Border>
                            <Border BackgroundColor="{StaticResource Gray300}"
                                   StrokeShape="RoundRectangle 20"
                                   Stroke="Transparent"
                                   Padding="16,8">
                                <Label Text="{Binding Recipe.DifficultyDisplay}"
                                       TextColor="{StaticResource ForegroundMuted}"
                                       FontSize="13"
                                       FontAttributes="Bold" />
                            </Border>
                        </HorizontalStackLayout>

                        <!-- Title -->
                        <Label Text="{Binding Recipe.Title}"
                               TextColor="{StaticResource Foreground}"
                               FontSize="32"
                               FontAttributes="Bold"
                               LineBreakMode="WordWrap" />

                        <!-- Info Pills (Time, Servings, Difficulty) -->
                        <HorizontalStackLayout Spacing="12">
                            <!-- Time Pill -->
                            <Border BackgroundColor="#FFF3E0"
                                   StrokeShape="RoundRectangle 20"
                                   Stroke="Transparent"
                                   Padding="12,8">
                                <HorizontalStackLayout Spacing="6">
                                    <Label Text="ðŸ•"
                                           FontSize="16"
                                           VerticalOptions="Center" />
                                    <Label TextColor="#FF6B35"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding Recipe.TotalTime}" />
                                                <Span Text=" Minuten" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </HorizontalStackLayout>
                            </Border>
                            
                            <!-- Servings Pill -->
                            <Border BackgroundColor="#E3F2FD"
                                   StrokeShape="RoundRectangle 20"
                                   Stroke="Transparent"
                                   Padding="12,8">
                                <HorizontalStackLayout Spacing="6">
                                    <Label Text="ðŸ‘¥"
                                           FontSize="16"
                                           VerticalOptions="Center" />
                                    <Label TextColor="#2196F3"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding Recipe.Servings}" />
                                                <Span Text=" Personen" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </HorizontalStackLayout>
                            </Border>
                            
                            <!-- Difficulty Pill -->
                            <Border BackgroundColor="#F3E5F5"
                                   StrokeShape="RoundRectangle 20"
                                   Stroke="Transparent"
                                   Padding="12,8">
                                <HorizontalStackLayout Spacing="6">
                                    <Label Text="ðŸ†"
                                           FontSize="16"
                                           VerticalOptions="Center" />
                                    <Label Text="{Binding Recipe.DifficultyDisplay}"
                                           TextColor="#9C27B0"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Border>
                        </HorizontalStackLayout>

                        <!-- Tags -->
                        <CollectionView ItemsSource="{Binding Recipe.Tags}"
                                        HeightRequest="40">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Horizontal" ItemSpacing="10" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <Border BackgroundColor="{StaticResource Gray200}"
                                           StrokeShape="RoundRectangle 16"
                                           Stroke="Transparent"
                                           Padding="14,8">
                                        <Label Text="{Binding StringFormat='#{0}'}"
                                               TextColor="{StaticResource Gray700}"
                                               FontSize="13" />
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Ingredients Card -->
                    <Frame x:Name="IngredientsCard"
                           Grid.Column="0" 
                           Grid.Row="1"
                           Style="{StaticResource CardFrame}"
                           Margin="0,0,0,0">
                        <VerticalStackLayout Spacing="16">
                            <Label Text="Zutaten"
                                   TextColor="{StaticResource Foreground}"
                                   FontSize="20"
                                   FontAttributes="Bold" />
                            
                            <CollectionView ItemsSource="{Binding Recipe.Ingredients}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="x:String">
                                        <HorizontalStackLayout Spacing="12" Padding="0,4">
                                            <Label Text="â€¢"
                                                   TextColor="{StaticResource Primary}"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center" />
                                            <Label Text="{Binding}"
                                                   TextColor="{StaticResource Foreground}"
                                                   FontSize="14"
                                                   LineBreakMode="WordWrap"
                                                   VerticalOptions="Center" />
                                        </HorizontalStackLayout>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Instructions Card -->
                    <Frame x:Name="InstructionsCard"
                           Grid.Column="1" 
                           Grid.Row="1"
                           Style="{StaticResource CardFrame}"
                           Margin="0,0,0,0">
                        <VerticalStackLayout Spacing="16">
                            <Label Text="Zubereitung"
                                   TextColor="{StaticResource Foreground}"
                                   FontSize="20"
                                   FontAttributes="Bold" />
                            
                            <CollectionView ItemsSource="{Binding InstructionSteps}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="viewmodels:InstructionStep">
                                        <Grid ColumnDefinitions="52,*" ColumnSpacing="16" Padding="0,8">
                                            <Border Grid.Column="0"
                                                   BackgroundColor="#FF8C42"
                                                   StrokeShape="Ellipse"
                                                   Stroke="Transparent"
                                                   WidthRequest="36"
                                                   HeightRequest="36"
                                                   VerticalOptions="Start">
                                                <Label Text="{Binding Number}"
                                                       TextColor="{StaticResource White}"
                                                       FontSize="15"
                                                       FontAttributes="Bold"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center" />
                                            </Border>
                                            <Label Grid.Column="1"
                                                   Text="{Binding Text}"
                                                   TextColor="{StaticResource Foreground}"
                                                   FontSize="14"
                                                   LineBreakMode="WordWrap"
                                                   VerticalOptions="Center" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>
                </Grid>
            </Grid>
        </ScrollView>
    </Grid>
</ContentPage>
