<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:RezeptePlaner.Maui.ViewModels"
             xmlns:models="clr-namespace:RezeptePlaner.Maui.Models"
             xmlns:controls="clr-namespace:RezeptePlaner.Maui.Controls"
             x:Class="RezeptePlaner.Maui.Views.RecipesPage"
             x:DataType="viewmodels:RecipeListViewModel"
             Title="Rezepte"
             BackgroundColor="{StaticResource Background}">

    <Grid RowDefinitions="Auto,*">
        <!-- Navigation Header -->
        <controls:NavigationHeader Grid.Row="0" CurrentPage="Rezepte" />

        <ScrollView Grid.Row="1">
            <Grid x:Name="MainContentGrid">
                
                <VisualStateManager.VisualStateGroups>
                    <VisualStateGroup x:Name="LayoutStates">
                        <!-- Small screens: Reduced padding -->
                        <VisualState x:Name="Small">
                            <VisualState.Setters>
                                <Setter TargetName="MainContentGrid" Property="Grid.Padding" Value="12" />
                                <Setter TargetName="HeaderStack" Property="VerticalStackLayout.Margin" Value="0,0,0,16" />
                                <Setter TargetName="TitleLabel" Property="Label.FontSize" Value="24" />
                                <Setter TargetName="SubtitleLabel" Property="Label.FontSize" Value="13" />
                                <Setter TargetName="RecipeFilterBarControl" Property="controls:RecipeFilterBar.Margin" Value="0,0,0,16" />
                            </VisualState.Setters>
                        </VisualState>
                        
                        <!-- Medium screens: Standard padding -->
                        <VisualState x:Name="Medium">
                            <VisualState.Setters>
                                <Setter TargetName="MainContentGrid" Property="Grid.Padding" Value="16" />
                                <Setter TargetName="HeaderStack" Property="VerticalStackLayout.Margin" Value="0,0,0,18" />
                                <Setter TargetName="TitleLabel" Property="Label.FontSize" Value="28" />
                                <Setter TargetName="SubtitleLabel" Property="Label.FontSize" Value="14" />
                                <Setter TargetName="RecipeFilterBarControl" Property="controls:RecipeFilterBar.Margin" Value="0,0,0,18" />
                            </VisualState.Setters>
                        </VisualState>
                        
                        <!-- Large screens: Full padding -->
                        <VisualState x:Name="Large">
                            <VisualState.Setters>
                                <Setter TargetName="MainContentGrid" Property="Grid.Padding" Value="20" />
                                <Setter TargetName="HeaderStack" Property="VerticalStackLayout.Margin" Value="0,0,0,20" />
                                <Setter TargetName="TitleLabel" Property="Label.FontSize" Value="32" />
                                <Setter TargetName="SubtitleLabel" Property="Label.FontSize" Value="14" />
                                <Setter TargetName="RecipeFilterBarControl" Property="controls:RecipeFilterBar.Margin" Value="0,0,0,20" />
                            </VisualState.Setters>
                        </VisualState>
                    </VisualStateGroup>
                </VisualStateManager.VisualStateGroups>
                
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
        
                <!-- Page Header -->
                <VerticalStackLayout x:Name="HeaderStack" Grid.Row="0">
                    <Label x:Name="TitleLabel"
                           Text="Rezeptbibliothek" 
                           TextColor="{StaticResource Foreground}"
                           FontAttributes="Bold"
                           Margin="0,0,0,8" />
                    <Label x:Name="SubtitleLabel"
                           Text="Entdecke und verwalte all deine Lieblingsrezepte."
                           TextColor="{StaticResource ForegroundMuted}" />
                </VerticalStackLayout>

                <!-- Search and Filter Section -->
                <controls:RecipeFilterBar x:Name="RecipeFilterBarControl"
                                          Grid.Row="1"
                                          SearchText="{Binding SearchText, Mode=TwoWay}"
                                          SelectedCategory="{Binding SelectedCategoryName, Mode=TwoWay}"
                                          SelectedDifficulty="{Binding SelectedDifficultyName, Mode=TwoWay}"
                                          MaxTimeMinutes="{Binding MaxTimeMinutes, Mode=TwoWay}"
                                          Categories="{Binding CategoryNames}"
                                          Difficulties="{Binding DifficultyNames}"
                                          ResultCount="{Binding ResultCount}" />

                <!-- Recipe List (CollectionView) -->
                <CollectionView Grid.Row="2"
                                x:Name="RecipeCollectionView"
                                ItemsSource="{Binding FilteredRecipes}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedRecipe}">
            
                    <CollectionView.EmptyView>
                        <VerticalStackLayout HorizontalOptions="Center" 
                                             VerticalOptions="Center"
                                             Padding="40">
                            <Label Text="ðŸ“‹"
                                   FontSize="60"
                                   HorizontalOptions="Center" />
                            <Label Text="Keine Rezepte gefunden"
                                   TextColor="{StaticResource ForegroundMuted}"
                                   FontSize="18"
                                   HorizontalOptions="Center"
                                   Margin="0,10,0,0" />
                            <Label Text="Erstellen Sie Ihr erstes Rezept!"
                                   TextColor="{StaticResource ForegroundMuted}"
                                   FontSize="14"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical"
                                         x:Name="GridLayout"
                                         Span="1"
                                         HorizontalItemSpacing="24"
                                         VerticalItemSpacing="24" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Recipe">
                            <Frame BackgroundColor="{StaticResource Surface}"
                                   BorderColor="Transparent"
                                   CornerRadius="20"
                                   Padding="0"
                                   HasShadow="True">
                                <Grid RowDefinitions="280,*">
                            
                                    <!-- Recipe Image with Favorite Button Overlay -->
                                    <Grid Grid.Row="0">
                                        <Image Source="{Binding ImageUrl}"
                                               Aspect="AspectFill"
                                               HeightRequest="280"
                                               VerticalOptions="Fill"
                                               HorizontalOptions="Fill">
                                            <Image.Clip>
                                                <RoundRectangleGeometry CornerRadius="20,20,0,0" 
                                                                       Rect="0,0,1000,280" />
                                            </Image.Clip>
                                        </Image>
                                
                                        <!-- Favorite Heart Button (Overlaid on Image) -->
                                        <Border BackgroundColor="{StaticResource Surface}"
                                                Stroke="Transparent"
                                                StrokeShape="RoundRectangle 20"
                                                Padding="8"
                                                Margin="12"
                                                HorizontalOptions="End"
                                                VerticalOptions="Start"
                                                WidthRequest="40"
                                                HeightRequest="40">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:RecipeListViewModel}}, Path=ToggleFavoriteCommand}"
                                                                     CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>
                                            <Label Text="{Binding IsFavorite, Converter={StaticResource FavoriteToHeartConverter}}"
                                                   TextColor="{Binding IsFavorite, Converter={StaticResource FavoriteToColorConverter}}"
                                                   FontSize="20"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center" />
                                        </Border>
                                    </Grid>
                            
                                    <!-- Recipe Info -->
                                    <VerticalStackLayout Grid.Row="1" Padding="20" Spacing="10">
                                
                                        <!-- Category Badge (Orange Pill) -->
                                        <Border BackgroundColor="{StaticResource Primary}"
                                                Stroke="Transparent"
                                                StrokeShape="RoundRectangle 15"
                                                Padding="12,6"
                                                HorizontalOptions="Start"
                                                Margin="0,0,0,4">
                                            <Label Text="{Binding CategoryDisplay}"
                                                   TextColor="{StaticResource Surface}"
                                                   FontSize="12"
                                                   FontAttributes="Bold" />
                                        </Border>
                                
                                        <!-- Title -->
                                        <Label Text="{Binding Title}"
                                               TextColor="{StaticResource Foreground}"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="2"
                                               Margin="0,0,0,4" />
                                
                                        <!-- Meta Info (Time + Portions) -->
                                        <HorizontalStackLayout Spacing="15" Margin="0,0,0,4">
                                            <HorizontalStackLayout Spacing="6">
                                                <Label Text="ðŸ•" FontSize="16" />
                                                <Label Text="{Binding TotalTime, StringFormat='{0} Min'}"
                                                       TextColor="{StaticResource ForegroundMuted}"
                                                       FontSize="13" />
                                            </HorizontalStackLayout>
                                            <HorizontalStackLayout Spacing="6">
                                                <Label Text="ðŸ‘¥" FontSize="16" />
                                                <Label Text="{Binding Servings, StringFormat='{0} Portionen'}"
                                                       TextColor="{StaticResource ForegroundMuted}"
                                                       FontSize="13" />
                                            </HorizontalStackLayout>
                                        </HorizontalStackLayout>
                                
                                        <!-- Tags (Gray Pills without #) -->
                                        <FlexLayout Wrap="Wrap" Margin="0,4,0,0">
                                            <CollectionView ItemsSource="{Binding Tags}">
                                                <CollectionView.ItemsLayout>
                                                    <LinearItemsLayout Orientation="Horizontal" ItemSpacing="6" />
                                                </CollectionView.ItemsLayout>
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate x:DataType="x:String">
                                                        <Border BackgroundColor="{StaticResource Gray200}"
                                                                Stroke="Transparent"
                                                                StrokeThickness="0"
                                                                StrokeShape="RoundRectangle 15"
                                                                Padding="10,5"
                                                                Margin="0,2">
                                                            <Label Text="{Binding .}"
                                                                   TextColor="{StaticResource ForegroundMuted}"
                                                                   FontSize="11" />
                                                        </Border>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>
                                        </FlexLayout>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </ScrollView>
    </Grid>
</ContentPage>
